<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.mapper.mysql.ProjectUserMapper">

    <!-- 查询项目成员 -->
    <select id="selectUsersByProjectId" parameterType="java.lang.Integer" resultType="com.example.entity.User">
        SELECT
            u.id,
            u.username,
            u.email,
            u.status,
            u.created_at AS createdAt,
            u.updated_at AS updatedAt,
            u.role_id AS roleId,
            r.name AS roleName
        FROM project_user pu
                 INNER JOIN `user` u ON pu.user_id = u.id
                 LEFT JOIN user_role ur ON ur.user_id = u.id
                 LEFT JOIN role r ON r.id = ur.role_id
        WHERE pu.project_id = #{projectId}
        ORDER BY u.id DESC
    </select>

    <!-- 判断成员是否存在 -->
    <select id="countUserInProject" parameterType="map" resultType="int">
        SELECT COUNT(*)
        FROM project_user
        WHERE project_id = #{projectId} AND user_id = #{userId}
    </select>

    <!-- 添加成员 -->
    <insert id="insertProjectUser" parameterType="map">
        INSERT INTO project_user (project_id, user_id)
        VALUES (#{projectId}, #{userId})
    </insert>

    <!-- 删除成员 -->
    <delete id="deleteProjectUser" parameterType="map">
        DELETE FROM project_user
        WHERE project_id = #{projectId} AND user_id = #{userId}
    </delete>

    <!-- 批量删除 -->
    <delete id="deleteProjectUserBatch">
        DELETE FROM project_user
        WHERE project_id = #{projectId}
        AND user_id IN
        <foreach collection="userIds" item="id" open="(" separator="," close=")">
            #{id}
        </foreach>
    </delete>

</mapper>
